<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Drill Bot</title>
  <style>
    :root {
      --bg: #0b1020; --panel:#121a33; --ink:#e7ecff; --muted:#a9b7ff99; --accent:#7c9cff; --good:#6be675; --bad:#ff6b88; --warn:#ffd166;
    }
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:radial-gradient(1200px 800px at 20% -10%,#1a2250 0,#0b1020 50%); color:var(--ink)}
    .wrap{max-width:1000px;margin:0 auto; padding:24px}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
    .title{font-size:clamp(22px,3vw,32px); font-weight:800; letter-spacing:0.3px}
    .sub{color:var(--muted); font-size:14px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.25); padding:16px}
    .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
    select, input[type="number"], button, input[type="text"], textarea { background:#0f1836; color:var(--ink); border:1px solid rgba(255,255,255,0.15); border-radius:12px; padding:10px 12px; font-size:14px; outline:none }
    button{cursor:pointer; transition:transform .05s ease; font-weight:700}
    button:active{transform:scale(0.98)}
    .pill{display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:6px 10px; background:#0f1836; border:1px solid rgba(255,255,255,0.1); font-size:12px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr 1fr } }
    .prompt{font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:18px; line-height:1.5}
    .small{font-size:12px; color:var(--muted)}
    .ok{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .kbd{background:#09102b; border:1px solid rgba(255,255,255,0.12); padding:2px 6px; border-radius:6px; font-family:inherit; font-size:12px}
    .hint{border-left:3px solid var(--accent); padding-left:10px}
    details summary{cursor:pointer; list-style:none}
    details summary::-webkit-details-marker{display:none}
    .score{display:flex; gap:10px; align-items:center}
    .score .n{font-weight:800; font-size:18px}
    .ghost{opacity:.7}
    .footer{margin-top:20px; color:var(--muted); font-size:12px}
    .tag{padding:2px 6px; border-radius:6px; background:#0f1836; border:1px solid rgba(255,255,255,0.1)}
    .hl{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">üß† Math Drill Bot</div>
        <div class="sub">Practice integrals with instant feedback, hints, and streaks. Host this single file on GitHub Pages.</div>
      </div>
      <div class="pill score" id="scoreBar">
        <span>‚≠ê Score:</span><span class="n" id="score">0</span>
        <span class="ghost">|</span>
        <span>üî• Streak:</span><span class="n" id="streak">0</span>
      </div>
    </header>

    <div class="card grid">
      <div>
        <div class="row" style="margin-bottom:8px">
          <label>Topic
            <select id="topic">
              <option value="ulogTrig">u-sub: trig(log x)</option>
              <option value="eatbxTrig">e^{ax} ¬∑ trig(bx)</option>
              <option value="poly">Power rule</option>
              <option value="linear">u-sub: (ax+b)^m</option>
              <option value="ibp1">IBP: x¬∑e^{ax}</option>
              <option value="ibp2">IBP: x¬∑sin(bx)</option>
            </select>
          </label>
          <label>Difficulty
            <select id="difficulty">
              <option value="easy">Easy</option>
              <option value="med">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </label>
          <button id="newQ">New Problem ‚ûï</button>
        </div>

        <div class="prompt" id="problem">Click <span class="kbd">New Problem</span> to start.</div>

        <div class="row" style="margin-top:10px">
          <input id="answer" type="text" placeholder="Type an antiderivative F(x) (you can omit +C). Use sin, cos, tan, log, exp. Use ^ for powers." style="flex:1"/>
          <button id="check">Check ‚úÖ</button>
          <button id="hintBtn">Hint üí°</button>
          <button id="solutionBtn">Show Solution üß©</button>
        </div>

        <div id="feedback" class="small" style="margin-top:8px"></div>

        <details id="hintBox" style="margin-top:10px">
          <summary class="hl">Hint</summary>
          <div class="hint" id="hintContent"></div>
        </details>

        <details id="solnBox" style="margin-top:10px">
          <summary class="hl">Solution (expand after trying!)</summary>
          <div id="solutionContent"></div>
        </details>

      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:6px">How answers are checked</div>
        <div class="small">
          We numerically differentiate your answer <span class="tag">F(x)</span> and compare it to the target integrand <span class="tag">f(x)</span> at several random points.
          If <span class="tag">F'(x) ‚âà f(x)</span> within tolerance, it counts as correct. You can write <span class="tag">^</span> for powers and <span class="tag">log</span> for natural log.
          Constants like <span class="tag">pi</span> and <span class="tag">e</span> are understood. Domain matters (e.g., <span class="tag">log x</span> requires <span class="tag">x&gt;0</span>).
        </div>
        <div style="margin-top:10px">
          <div class="small">Input helpers:</div>
          <div class="small">
            <span class="kbd">sin(x)</span>, <span class="kbd">cos(x)</span>, <span class="kbd">tan(x)</span>, <span class="kbd">log(x)</span>, <span class="kbd">exp(x)</span>, <span class="kbd">sqrt(x)</span>, <span class="kbd">pi</span>, <span class="kbd">e</span>
          </div>
        </div>
        <hr style="border-color:rgba(255,255,255,0.08); margin:14px 0"/>
        <div style="font-weight:700; margin-bottom:6px">Progress</div>
        <div class="row small">
          <div>Correct today: <span id="correctToday">0</span></div>
          <div>Attempts today: <span id="attemptsToday">0</span></div>
          <div>Accuracy: <span id="accToday">0%</span></div>
        </div>
        <div class="footer">Tip: Press <span class="kbd">Enter</span> to check. Press <span class="kbd">N</span> for new problem.</div>
      </div>
    </div>
  </div>

  <script>
  // === Utility: persistence ===
  const storageKey = 'math-drill-progress-v1';
  const todayKey = () => new Date().toISOString().slice(0,10);
  const loadState = () => JSON.parse(localStorage.getItem(storageKey) || '{}');
  const saveState = s => localStorage.setItem(storageKey, JSON.stringify(s));

  function bumpProgress(ok){
    const s = loadState();
    const d = todayKey();
    s[d] = s[d] || {attempts:0, correct:0, score:0, streak:0};
    s[d].attempts++;
    if(ok){ s[d].correct++; s[d].score+=10; s[d].streak++ } else { s[d].streak=0 }
    saveState(s);
    renderProgress();
  }
  function renderProgress(){
    const s = loadState(); const d = todayKey(); const t = s[d] || {attempts:0, correct:0, score:0, streak:0};
    byId('score').textContent = t.score;
    byId('streak').textContent = t.streak;
    byId('correctToday').textContent = t.correct;
    byId('attemptsToday').textContent = t.attempts;
    byId('accToday').textContent = t.attempts? Math.round(100*t.correct/t.attempts)+"%" : '0%';
  }

  // === Problem generation ===
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const randint = (a,b)=>Math.floor(rand(a,b+1));
  const choice = arr => arr[Math.floor(Math.random()*arr.length)];

  function fmtPow(base, n){
    if(n===1) return base;
    if(n===2) return base+"^2";
    return base+"^"+n;
  }

  function problem_ulogTrig(diff){
    const n = diff==='easy' ? choice([0,1]) : diff==='med' ? choice([0,1,2]) : choice([0,1,2,3]);
    const trig = choice(['cos','sin']);
    const integrandLatex = `${fmtPow('x', n)}¬∑${trig}(log x)`;
    const a = n+1; // exponent after substitution
    const F = trig==='cos'
      ? (x)=> Math.pow(x,n+1)/(a*a+1) * ( a*Math.cos(Math.log(x)) + Math.sin(Math.log(x)) )
      : (x)=> Math.pow(x,n+1)/(a*a+1) * ( a*Math.sin(Math.log(x)) - Math.cos(Math.log(x)) );
    const f = (x)=> Math.pow(x,n) * (trig==='cos'? Math.cos(Math.log(x)): Math.sin(Math.log(x)) );

    const hint = [
      `Let u = log x (so x>0). Then dx = x du and x = e^u.`,
      `Rewrite integrand: x^${n}¬∑${trig}(log x) dx = e^{${n}u}¬∑${trig}(u) ¬∑ e^{u} du = e^{${n+1}u}¬∑${trig}(u) du.`,
      `Use the template ‚à´ e^{au} cos(bu) du or ‚à´ e^{au} sin(bu) du with a=${a}, b=1.`,
      `Back-substitute u = log x, e^{u} = x.`
    ].join('<br>');

    const sol = trig==='cos'
      ? `F(x) = x^${n+1}/(${a*a+1}) ¬∑ ( ${a}¬∑cos(log x) + sin(log x) ) + C`
      : `F(x) = x^${n+1}/(${a*a+1}) ¬∑ ( ${a}¬∑sin(log x) - cos(log x) ) + C`;

    return { prompt:`‚à´ ${integrandLatex} dx`, f, F, hint, solution: sol, domain:'x>0', testXs: ()=>[0.6, 0.9, 1.3, 2.1, 2.8] };
  }

  function problem_eatbxTrig(diff){
    const a = diff==='easy'?1: diff==='med'? randint(1,2) : randint(1,3);
    const b = diff==='easy'?1: diff==='med'? randint(1,2) : randint(1,3);
    const trig = choice(['cos','sin']);
    const prompt = `‚à´ e^{${a}x} ¬∑ ${trig}(${b}x) dx`;
    const denom = a*a + b*b;
    const F = trig==='cos'
      ? (x)=> Math.exp(a*x) * ( a*Math.cos(b*x) + b*Math.sin(b*x) )/denom
      : (x)=> Math.exp(a*x) * ( a*Math.sin(b*x) - b*Math.cos(b*x) )/denom;
    const f = (x)=> Math.exp(a*x) * (trig==='cos'? Math.cos(b*x): Math.sin(b*x));
    const hint = [
      `Try integration by parts twice, or recall the standard forms:`,
      `‚à´ e^{ax}cos(bx) dx = e^{ax}(a cos bx + b sin bx)/(a^2+b^2) + C`,
      `‚à´ e^{ax}sin(bx) dx = e^{ax}(a sin bx - b cos bx)/(a^2+b^2) + C`
    ].join('<br>');
    const sol = trig==='cos'
      ? `F(x) = e^{${a}x} ( ${a} cos ${b}x + ${b} sin ${b}x ) / (${denom}) + C`
      : `F(x) = e^{${a}x} ( ${a} sin ${b}x - ${b} cos ${b}x ) / (${denom}) + C`;
    return { prompt, f, F, hint, solution: sol, domain:'all', testXs: ()=>[-0.6, -0.2, 0.0, 0.4, 0.9] };
  }

  function problem_poly(diff){
    const n = diff==='easy'? randint(1,3) : diff==='med'? randint(2,5) : randint(3,7);
    const prompt = `‚à´ x^${n} dx`;
    const F = (x)=> Math.pow(x,n+1)/(n+1);
    const f = (x)=> Math.pow(x,n);
    const hint = `Use the power rule: ‚à´ x^n dx = x^{n+1}/(n+1) + C (for n ‚â† -1).`;
    const sol = `F(x) = x^${n+1}/(${n+1}) + C`;
    return { prompt, f, F, hint, solution: sol, domain:'all', testXs: ()=>[-2, -0.5, 0.3, 1.2, 2.1] };
  }

  function problem_linear(diff){
    const a = diff==='easy'? randint(1,3) : randint(2,5);
    const b = randint(-3,3);
    const m = diff==='easy'? randint(1,2) : diff==='med'? randint(2,4) : randint(3,6);
    const prompt = `‚à´ ( ${a}x ${b>=0?'+':''}${b} )^${m} dx`;
    const F = (x)=> Math.pow(a*x + b, m+1) / (a*(m+1));
    const f = (x)=> Math.pow(a*x + b, m);
    const hint = `Let u = ${a}x ${b>=0?'+':''}${b}, so du = ${a} dx. Then ‚à´ u^m ¬∑ (dx) = (1/${a}) ‚à´ u^m du.`;
    const sol = `F(x) = ( ${a}x ${b>=0?'+':''}${b} )^${m+1} / (${a}¬∑${m+1}) + C`;
    return { prompt, f, F, hint, solution: sol, domain:'all', testXs: ()=>[-1.3, -0.2, 0.0, 0.7, 1.4] };
  }

  function problem_ibp1(diff){
    const a = diff==='easy'?1: randint(1,3);
    const prompt = `‚à´ x ¬∑ e^{${a}x} dx`;
    const F = (x)=> Math.exp(a*x)*(x/a - 1/(a*a));
    const f = (x)=> x*Math.exp(a*x);
    const hint = `IBP with f=x (df=dx) and dg=e^{${a}x} dx (g=e^{${a}x}/${a}).`;
    const sol = `F(x) = (e^{${a}x}/${a})(x - 1/${a}) + C`;
    return { prompt, f, F, hint, solution: sol, domain:'all', testXs: ()=>[-0.4, 0, 0.3, 0.8, 1.1] };
  }

  function problem_ibp2(diff){
    const b = diff==='easy'?1: randint(1,4);
    const prompt = `‚à´ x ¬∑ sin(${b}x) dx`;
    const F = (x)=> -x*Math.cos(b*x)/b + Math.sin(b*x)/(b*b);
    const f = (x)=> x*Math.sin(b*x);
    const hint = `IBP with f=x (df=dx) and dg=sin(${b}x) dx (g=-cos(${b}x)/${b}).`;
    const sol = `F(x) = -x cos(${b}x)/${b} + sin(${b}x)/${b*b} + C`;
    return { prompt, f, F, hint, solution: sol, domain:'all', testXs: ()=>[-0.7, -0.2, 0.3, 0.9, 1.4] };
  }

  const generators = { ulogTrig: problem_ulogTrig, eatbxTrig: problem_eatbxTrig, poly: problem_poly, linear: problem_linear, ibp1: problem_ibp1, ibp2: problem_ibp2 };

  // === Parsing and checking ===
  function sanitize(expr){
    if(!expr) return '';
    expr = expr.replace(/\s+/g,'');
    expr = expr.replace(/\+C$/i,'');
    expr = expr.replace(/\^/g,'**'); // power
    expr = expr.replace(/pi/gi,'Math.PI');
    // replace e^... with Math.E**...
    expr = expr.replace(/(^|[^a-zA-Z0-9_])e\*\*/g, '$1Math.E**');
    // functions
    expr = expr.replace(/sin\(/gi,'Math.sin(')
               .replace(/cos\(/gi,'Math.cos(')
               .replace(/tan\(/gi,'Math.tan(')
               .replace(/log\(/gi,'Math.log(')
               .replace(/exp\(/gi,'Math.exp(')
               .replace(/sqrt\(/gi,'Math.sqrt(');
    return expr;
  }

  function compile(expr){
    const sanitized = sanitize(expr);
    try {
      // Allow only x, Math.*; no other identifiers
      if(/[^\w\.\*\+\-\/\(\)\,\^\s]/.test(sanitized.replace(/Math\.[a-zA-Z]+/g,''))){
        // This heuristic keeps things simple; we already sanitized common tokens
      }
      return new Function('x', `return (${sanitized});`);
    } catch(e){ return null }
  }

  function numDeriv(f, x){
    const h = 1e-4*(1+Math.abs(x));
    try { return (f(x+h)-f(x-h))/(2*h) } catch(e){ return NaN }
  }

  function relClose(a,b){
    const A = Math.abs(a), B = Math.abs(b);
    const tol = 1e-2 + 1e-2*B; // absolute + relative
    return Math.abs(a-b) <= tol;
  }

  // === App state ===
  let current = null;

  function byId(id){ return document.getElementById(id) }
  function setHTML(id, html){ byId(id).innerHTML = html }

  function newProblem(){
    byId('feedback').textContent = '';
    byId('answer').value = '';
    byId('hintBox').open = false; byId('solnBox').open = false;
    const topic = byId('topic').value;
    const diff = byId('difficulty').value;
    const gen = generators[topic];
    current = gen(diff);
    setHTML('problem', current.prompt);
    setHTML('hintContent', current.hint + (current.domain? `<div class="small" style="margin-top:6px">Domain note: <b>${current.domain}</b></div>`: ''));
    setHTML('solutionContent', `<div class="hint">${current.solution}</div>`);
  }

  function checkAnswer(){
    if(!current){ return }
    const user = byId('answer').value;
    const Fuser = compile(user);
    if(!Fuser){ setHTML('feedback', `<span class='bad'>‚ö†Ô∏è Couldn't parse that. Try simpler syntax (use sin, cos, log, exp, ^).</span>`); bumpProgress(false); return }

    const xs = current.testXs();
    let ok = true; let samples=0; let worst=0;
    for(const x of xs){
      if(current.domain==='x>0' && x<=0){ continue }
      const dF = numDeriv(Fuser, x);
      const fx = current.f(x);
      if(!isFinite(dF) || !isFinite(fx)) { ok=false; break }
      const diff = Math.abs(dF - fx);
      worst = Math.max(worst, diff);
      if(!relClose(dF, fx)) { ok=false; }
      samples++;
    }
    if(samples===0){ ok=false }

    bumpProgress(ok);
    if(ok){
      setHTML('feedback', `<span class='ok'>‚úÖ Nice! Your derivative matched the integrand (max error ~ ${worst.toExponential(2)}). Keep the streak going üî•</span>`);
    } else {
      setHTML('feedback', `<span class='warn'>ü§î Not quite. Expand <b>Hint</b> or <b>Solution</b> for guidance, then try again. You got this!</span>`);
    }
  }

  // === Events ===
  byId('newQ').addEventListener('click', newProblem);
  byId('check').addEventListener('click', checkAnswer);
  byId('hintBtn').addEventListener('click', ()=> byId('hintBox').open = true);
  byId('solutionBtn').addEventListener('click', ()=> byId('solnBox').open = true);
  byId('answer').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ checkAnswer() } });
  window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='n'){ newProblem() } });

  renderProgress();
  </script>
</body>
</html>
